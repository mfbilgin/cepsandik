version: "3.8"

# ==========================================
# CepSandƒ±k Production Docker Compose
# ==========================================
# Digital Ocean Droplet'ta √ßalƒ±≈ütƒ±rƒ±lacak konfig√ºrasyon

services:
  # üåê OpenResty Gateway (SSL + Auth)
  gateway:
    image: ghcr.io/${GITHUB_OWNER}/cepsandik-gateway:latest
    container_name: cepsandik_gateway
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      JWT_SECRET: ${JWT_SECRET}
      INTERNAL_JWT_SECRET: ${INTERNAL_JWT_SECRET}
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - user-service
      - community-service
    networks:
      - cepsandik-net

  # üë§ User Service
  user-service:
    image: ghcr.io/${GITHUB_OWNER}/cepsandik-user-service:latest
    container_name: cepsandik_user_service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATABASE_URL: jdbc:postgresql://postgres:5432/userdb
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
      AWS_SECRET_KEY: ${AWS_SECRET_KEY}
      FRONTEND_URL: ${FRONTEND_URL}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - cepsandik-net

  # üèòÔ∏è Community Service
  community-service:
    image: ghcr.io/${GITHUB_OWNER}/cepsandik-community-service:latest
    container_name: cepsandik_community_service
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATABASE_URL: jdbc:postgresql://postgres:5432/communitydb
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      INTERNAL_JWT_SECRET: ${INTERNAL_JWT_SECRET}
    depends_on:
      - postgres
    networks:
      - cepsandik-net

  # üêò PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: cepsandik_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - cepsandik-net

  # ‚ö° Redis
  redis:
    image: redis:7-alpine
    container_name: cepsandik_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - cepsandik-net

  # üì® RabbitMQ
  rabbitmq:
    image: rabbitmq:3-alpine
    container_name: cepsandik_rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cepsandik-net

networks:
  cepsandik-net:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
